
<h1>Seaching for - <%= @search_term %></h1>

<%= form_tag action: 'index' do %>
  <p>New Search Term:
  <%= text_field_tag 'search', @search_term %></p>
  <%= submit_tag "Search" %>

<% end %>

<div id="map"></div>
<script>
var map = L.map('map')

L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

/* Create the GeoJSON objects */

var geojson_jobs = {
  "type": "FeatureCollection",
  "features" : [
<% @dice_jobs.each do |job| %>
  <% scs = split_city_state job["location"] %>
  <% city_loc = find_coordinates(scs[0],scs[1]) %>
  <%  if city_loc.nil? then city_loc = find_coordinates("not found", "us") end %>
  {
   "type" : "Feature",
   "properties": {
     "show_on_map" : true,
      "name" : "<%= job["jobTitle"] %>",
      "link" : "<%= job["detailUrl"] %>",
      "company" : "<%= job["company"] %>",
      "city" : "<%= job["location"] %>",
      "date" : "<%= job["date"] %>",
    },
    "geometry" : {
      "type" : "Point",
      "coordinates" : [ <%= city_loc.long %>, <%= city_loc.lat %> ]
    }
  },
<% end %>
]};

</script>
<script>

function onEachFeature(feature, layer) {
  var popupContent = "";

  if (feature.properties) {
    popupContent += "<a href='" + feature.properties.link + "' target='_blank'>" + feature.properties.name + "</a><br>";
    popupContent += feature.properties.company + "<br>";
    popupContent += feature.properties.city + "<br>";
    popupContent += feature.properties.date + "<br>";
  }


  layer.bindPopup(popupContent);
}
var markers = L.markerClusterGroup({
  spiderfyDistanceMultiplier: 2,

});

var geoJsonLayer = L.geoJSON(geojson_jobs, {

  onEachFeature: onEachFeature,

    pointToLayer: function(feature, latlng) {
        return L.circleMarker(latlng, {
            radius: 8,
            fillColor: "#0080FF",
            color: "#000",
            weight: 1,
            opacity: 0.75,
            fillOpacity: 0.8
        });
    }

})

markers.addLayer(geoJsonLayer);
map.addLayer(markers);


</script>
